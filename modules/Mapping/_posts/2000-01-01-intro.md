---
title: Mapping
---


The easiest way to define presence/absence of vOTUs within a sample and then estimate their abundance, 
is by mapping the reads back to the assembly. 

:pencil2: How can we use the BAM files?  We can use automatic tools (like MetaPop) or ... create an Anvi'o database!

There are loads of mappers/aligners available ([BWA](https://github.com/lh3/bwa), [bowtie2](https://github.com/BenLangmead/bowtie2), and [bbmap](https://jgi.doe.gov/data-and-tools/software-tools/bbtools/bb-tools-user-guide/bbmap-guide/) to name a few), but we're going to use [Minimap2](https://github.com/lh3/minimap2).

Whatever mapper you use, it's very likely that you'll use [samtools](https://github.com/samtools/samtools) to process the output.

## Installation 

Here you can create an environment with both minimap2 and samtools installed:

:bulb: When mapping against a subset of contigs, you might want to increase the stringency of the mapping. We won't change the defaults in this tutorial.

```bash
mamba create -n mapping \
  -c conda-forge -c bioconda\
  minimap2 samtools
```

Remember to activate the environment and invoke the help menus as we have done previously. This is a great way to test that you're in the correct environment and your programmes have installed successfully.

## Map
A typical minimap2 command looks like this:

```bash
# DO NOT COPY THIS COMMAND, adapt it before
minimap2 -x sr -a -t 8 <MY_VOTUS.fa> <reads-R1.fq.gz> <reads-R2.fq.gz>  > output.sam 
```

To produce the sorted bam file, we can pipe the output directly to samtools:

```bash
# DO NOT COPY THIS COMMAND, adapt it before
minimap2 -x sr -a -t 8 <MY_VOTUS.fa> <sample_X_R1.fq.gz> <sample_X_R2.fq.gz> | samtools view -bS -F4 - | samtools sort --write-index -@ 8 -o <sample_X.bam> -
```

There's a lot going on in this command (because it's actually three commands separated by pipes (`|`) :open_mouth:),
be sure to look up what pipes are, and what the minimap2 parameters might be doing.

The alignments will be saved in BAM files. You should look up what BAM files are and what the difference is between BAM and SAM...

For the bam file to be usable in anvio, you will need to index your bam file. You can use Samtools to do this:

```bash
# DO NOT COPY THIS COMMAND, adapt it before
samtools index -b <sample_X.bam> 
```

:pencil2: Now try yourself

* Create a directory where to store the alignments (eg. `~/bams/`)
* Use the structure of the above command to map the reads from sample_01 to the vOTUs you created earlier.
* Optionally, map all the other samples


### EBAME commands

You can process the files manually:

```bash

mkdir -p ~/bams/
VOTUS=vOTUs_representatives.fa

minimap2 -x sr -a -t 8 $VOTUS $VIROME/ERR6797443_{1,2}.fastq.gz | samtools view -bS -F4 - | samtools sort --write-index -@ 8 -o ~/bams/sample_1.bam -
minimap2 -x sr -a -t 8 $VOTUS $VIROME/ERR6797444_{1,2}.fastq.gz | samtools view -bS -F4 - | samtools sort --write-index -@ 8 -o ~/bams/sample_2.bam -
minimap2 -x sr -a -t 8 $VOTUS $VIROME/ERR6797443_{1,2}.fastq.gz | samtools view -bS -F4 - | samtools sort --write-index -@ 8 -o ~/bams/sample_3.bam -
```


  
## Exploring your data with Anvi'o

You can do the Anvi'o data processing yourself on your own computer using the anvio install that you have used earlier in the week. We will provide the necessary files for you to download from Dropbox so you don't have to worry about downloading your files from the VM.

:warning: The filenames in the dropbox download might be slightly different, but the content will be the same
